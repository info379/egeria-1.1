<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Egeria • UpManage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f0f12;
      --panel: #16161b;
      --text: #e9e9ee;
      --muted: #9aa0a6;
      --brand: #7c4dff;
      --accent: #19c37d;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(124,77,255,.08), transparent 60%),
                  radial-gradient(1400px 1000px at 90% 0%, rgba(25,195,125,.06), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh; display: flex; flex-direction: column;
    }
    header {
      padding: 16px 20px; border-bottom: 1px solid #22242a; backdrop-filter: blur(6px);
      position: sticky; top: 0; background: rgba(15,15,18,.75);
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, var(--brand), var(--accent));
      display: grid; place-items: center; font-weight: 800; color: white;
    }
    .title { font-weight: 700; letter-spacing: .2px }
    .wrap { max-width: 920px; width: 100%; margin: 0 auto; padding: 16px; flex: 1; display: flex; flex-direction: column; gap: 16px }
    .chat {
      background: var(--panel); border: 1px solid #262830; border-radius: 16px;
      padding: 12px; display: flex; flex-direction: column; gap: 12px; min-height: 60vh;
    }
    .messages { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding: 8px }
    .msg {
      max-width: 80%; padding: 10px 12px; border-radius: 12px; line-height: 1.4;
      white-space: pre-wrap; word-wrap: break-word;
    }
    .user { align-self: flex-end; background: #243043; border: 1px solid #2e3a4f }
    .assistant { align-self: flex-start; background: #1d1f26; border: 1px solid #2a2d36 }
    .meta { font-size: 12px; color: var(--muted); margin-top: 4px }
    .composer {
      display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 8px; border-top: 1px solid #262830;
      background: rgba(0,0,0,.2); border-radius: 12px;
    }
    textarea {
      width: 100%; resize: none; border: 1px solid #2a2d36; border-radius: 10px; padding: 10px 12px;
      min-height: 64px; background: #14161a; color: var(--text); outline: none;
    }
    button {
      background: linear-gradient(135deg, var(--brand), var(--accent));
      color: white; font-weight: 700; border: none; border-radius: 10px; padding: 0 18px; cursor: pointer;
    }
    .row { display: flex; gap: 12px; align-items: center; justify-content: space-between }
    .switch { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--muted) }
    input[type="checkbox"] { transform: scale(1.2) }
    .hint { font-size: 12px; color: var(--muted) }
  </style>
</head>
<body>
  <header>
    <div class="logo">E</div>
    <div class="title">Egeria • UpManage</div>
  </header>

  <main class="wrap">
    <div class="chat">
      <div class="row">
        <div class="switch">
          <label><input type="checkbox" id="stream" checked /> Streaming</label>
          <span class="hint">Risposte progressive in tempo reale</span>
        </div>
        <button id="clear">Pulisci chat</button>
      </div>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" placeholder="Chiedi a Egeria… (es. “Fammi un piano PPC per PMI B2B con 5k€/mese”)"></textarea>
        <button id="send">Invia</button>
      </div>
    </div>
  </main>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const streamToggle = document.getElementById('stream');

    let history = JSON.parse(localStorage.getItem('egeria_history') || '[]');
    function saveHistory(){ localStorage.setItem('egeria_history', JSON.stringify(history)); }

    function appendMessage(role, content) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      wrap.textContent = content;
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return wrap;
    }

    function appendMeta(text) {
      const el = document.createElement('div');
      el.className = 'meta';
      el.textContent = text;
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return el;
    }

    async function sendNonStreaming(prompt) {
      const res = await fetch('/api/egeria', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, history }),
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      return data.response || '';
    }

    async function sendStreaming(prompt, targetEl) {
      const res = await fetch('/api/egeria/stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, history }),
      });
      if (!res.ok || !res.body) throw new Error(await res.text());

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let assistantText = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });

        for (const line of chunk.split('\n')) {
          const trimmed = line.trim();
          if (!trimmed.startsWith('data:')) continue;
          const payload = trimmed.replace(/^data:\s*/, '');
          if (payload === '[DONE]') continue;
          try {
            const json = JSON.parse(payload);
            if (json.error) throw new Error(json.error + (json.details ? ' — ' + json.details : ''));
            if (json.delta) {
              assistantText += json.delta;
              targetEl.textContent = assistantText;
              messagesEl.scrollTop = messagesEl.scrollHeight;
            }
            if (json.done) return assistantText;
          } catch (e) {}
        }
      }
      return assistantText;
    }

    async function handleSend() {
      const prompt = inputEl.value.trim();
      if (!prompt) return;
      inputEl.value = '';
      appendMessage('user', prompt);
      history.push({ role: 'user', content: prompt });
      saveHistory();

      const assistantEl = appendMessage('assistant', '…');
      const metaEl = appendMeta(streamToggle.checked ? 'In streaming…' : 'Elaborazione…');

      try {
        let answer = '';
        if (streamToggle.checked) {
          answer = await sendStreaming(prompt, assistantEl);
        } else {
          answer = await sendNonStreaming(prompt);
          assistantEl.textContent = answer;
        }
        history.push({ role: 'assistant', content: answer });
        saveHistory();
        metaEl.textContent = 'Fatto.';
      } catch (err) {
        console.error(err);
        assistantEl.textContent = 'Si è verificato un errore. Riprova più tardi.';
        metaEl.textContent = 'Errore.';
      }
    }

    for (const m of history) appendMessage(m.role, m.content);

    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); handleSend();
      }
    });
    clearBtn.addEventListener('click', () => {
      history = [];
      saveHistory();
      messagesEl.innerHTML = '';
      appendMeta('Chat pulita.');
    });
  </script>
</body>
</html>